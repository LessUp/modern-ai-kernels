name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check C++/CUDA formatting
        uses: jidicula/clang-format-action@v4.13.0
        with:
          clang-format-version: '17'
          check-path: 'include src tests benchmarks'
          fallback-style: 'Google'

  lint:
    name: Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install clang-tidy
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-tidy-17

      - name: Run clang-tidy
        run: |
          find include src -name '*.cpp' -o -name '*.hpp' | head -20 | xargs clang-tidy-17 --config-file=.clang-tidy -p . || true
        continue-on-error: true

  build-cuda11:
    name: Build (CUDA 11.8)
    runs-on: ubuntu-latest
    container:
      image: nvidia/cuda:11.8.0-devel-ubuntu22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y cmake ninja-build git

      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CUDA_ARCHITECTURES="70;75;80;86"

      - name: Build
        run: cmake --build build --parallel

  build-cuda12:
    name: Build (CUDA 12.2)
    runs-on: ubuntu-latest
    container:
      image: nvidia/cuda:12.2.0-devel-ubuntu22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y cmake ninja-build git

      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CUDA_ARCHITECTURES="70;75;80;86;89;90"

      - name: Build
        run: cmake --build build --parallel

  test:
    name: Tests
    runs-on: ubuntu-latest
    needs: [build-cuda12]
    container:
      image: nvidia/cuda:12.2.0-devel-ubuntu22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y cmake ninja-build git

      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Debug \
            -DBUILD_TESTING=ON \
            -DCMAKE_CUDA_ARCHITECTURES="70;75;80;86;89;90"

      - name: Build
        run: cmake --build build --parallel

      - name: Run tests
        run: ctest --test-dir build --output-on-failure
        continue-on-error: true
